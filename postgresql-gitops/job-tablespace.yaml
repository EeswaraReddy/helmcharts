apiVersion: batch/v1
kind: Job
metadata:
  name: create-tablespaces
  namespace: dev-postgresql
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: psql
          image: bitnami/postgresql:latest
          env:
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgresql
                  key: postgres-password      # ðŸ‘ˆ Correct secret key
            - name: PGUSER
              value: postgres                 # ðŸ‘ˆ postgres superuser
          command: ["psql"]
          args:
            [
              "-h", "postgresql",             # ðŸ‘ˆ Host (your service name)
              "-U", "$(PGUSER)",              # ðŸ‘ˆ Username from env
              "-d", "postgres",               # ðŸ‘ˆ Database to connect
              "-f", "/scripts/tablespace.sql" # ðŸ‘ˆ SQL file inside container
            ]
          volumeMounts:
            - name: sql-scripts
              mountPath: /scripts              # ðŸ‘ˆ Mount ConfigMap as /scripts
      volumes:
        - name: sql-scripts
          configMap:
            name: tablespace-sql               # ðŸ‘ˆ ConfigMap with your SQL
